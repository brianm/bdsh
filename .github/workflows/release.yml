name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-14
          - target: x86_64-apple-darwin
            runner: macos-13
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build release tarball
        run: make dist TARGET=${{ matrix.target }}
      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.target }}
          path: dist/out/*.tar.gz

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: dist/out
          pattern: dist-*
          merge-multiple: true
      - name: Get version
        id: version
        run: echo "version=$(make version)" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/out/*.tar.gz
          generate_release_notes: true

  homebrew:
    name: Update Homebrew
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: dist/out
          pattern: dist-*
          merge-multiple: true
      - name: Generate formula
        run: make formula
      - name: Push to tap
        run: |
          git clone https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/brianm/homebrew-tools.git tap
          cp dist/out/bdsh.rb tap/Formula/
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/bdsh.rb
          git commit -m "bdsh ${{ needs.release.outputs.version }}"
          git push

  aur:
    name: Update AUR
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate PKGBUILD
        run: make pkgbuild
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat >> ~/.ssh/config <<EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
      - name: Push to AUR
        run: |
          git clone ssh://aur@aur.archlinux.org/bdsh.git aur-repo
          cp dist/out/PKGBUILD aur-repo/
          cd aur-repo
          # Generate .SRCINFO using Arch container
          docker run --rm -v "$PWD:/pkg" archlinux:base-devel bash -c "
            chown -R nobody /pkg
            cd /pkg
            sudo -u nobody makepkg --printsrcinfo > .SRCINFO
          "
          git config user.name "Brian McCallister"
          git config user.email "brianm@apache.org"
          git add PKGBUILD .SRCINFO
          git diff --cached --quiet || git commit -m "Update to ${{ needs.release.outputs.version }}"
          git push
